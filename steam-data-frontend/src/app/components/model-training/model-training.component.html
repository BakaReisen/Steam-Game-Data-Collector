<div class="model-training-container">
  <div class="page-header">
    <h1>æœºå™¨å­¦ä¹ æ¨¡å‹è®­ç»ƒ</h1>
    <p class="subtitle">åŸºäºæ¸¸æˆæ•°æ®è®­ç»ƒ RandomForest æ¨¡å‹,é¢„æµ‹æ¸¸æˆåœ¨çº¿äººæ•°ç›¸å…³æŒ‡æ ‡,æ”¯æŒç¼ºå¤±æ•°æ®æ™ºèƒ½è¡¥å…¨</p>
  </div>

  <!-- æ•°æ®é›†é…ç½® -->
  <div class="dataset-config">
    <h2>æ•°æ®é›†é…ç½®</h2>
    <div class="config-form">
      <div class="form-group">
        <label for="dataFile">æ•°æ®æ–‡ä»¶</label>
        <input type="text" 
               id="dataFile" 
               [(ngModel)]="config.dataFile" 
               placeholder="Source data.csv">
        <small>è®­ç»ƒæ•°æ®æ–‡ä»¶è·¯å¾„ (é»˜è®¤ä½¿ç”¨ Source data.csv)</small>
      </div>

      <div class="form-group">
        <label>é€‰æ‹©è®­ç»ƒæ¨¡å‹</label>
        <div class="model-options">
          <label class="checkbox-option">
            <input type="checkbox" 
                   [(ngModel)]="config.trainCurrentPlayers">
            å½“å‰åœ¨çº¿äººæ•° (current_players)
          </label>
          <label class="checkbox-option">
            <input type="checkbox" 
                   [(ngModel)]="config.trainPeak24h">
            24å°æ—¶å³°å€¼ (peak_24h)
          </label>
          <label class="checkbox-option">
            <input type="checkbox" 
                   [(ngModel)]="config.trainPeakAllTime">
            å†å²æœ€é«˜åœ¨çº¿ (peak_alltime)
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¨¡å‹å‚æ•° -->
  <div class="model-params">
    <h2>æ¨¡å‹å‚æ•°</h2>
    <div class="params-grid">
      <div class="param-group">
        <label for="testSize">æµ‹è¯•é›†æ¯”ä¾‹</label>
        <input type="number" 
               id="testSize" 
               [(ngModel)]="config.testSize" 
               min="0.1" 
               max="0.5" 
               step="0.05">
        <small>0.2 = 20% æ•°æ®ç”¨äºæµ‹è¯•</small>
      </div>

      <div class="param-group">
        <label for="nEstimators">å†³ç­–æ ‘æ•°é‡</label>
        <input type="number" 
               id="nEstimators" 
               [(ngModel)]="config.nEstimators" 
               min="10" 
               max="500">
        <small>RandomForest ä¸­çš„æ ‘æ•°é‡</small>
      </div>

      <div class="param-group">
        <label for="maxDepth">æœ€å¤§æ·±åº¦</label>
        <input type="number" 
               id="maxDepth" 
               [(ngModel)]="config.maxDepth" 
               min="5" 
               max="50">
        <small>æ¯æ£µæ ‘çš„æœ€å¤§æ·±åº¦</small>
      </div>

      <div class="param-group">
        <label for="randomState">éšæœºç§å­</label>
        <input type="number" 
               id="randomState" 
               [(ngModel)]="config.randomState">
        <small>ä¿è¯ç»“æœå¯å¤ç°</small>
      </div>
    </div>
  </div>

  <!-- æ“ä½œæŒ‰é’® -->
  <div class="action-buttons">
    <button class="btn btn-primary" 
            (click)="startTraining()" 
            [disabled]="isTraining || !hasSelectedModel()">
      @if (isTraining) {
        <span class="spinner"></span>
        è®­ç»ƒä¸­...
      } @else {
        <span>ğŸš€</span>
        å¼€å§‹è®­ç»ƒ
      }
    </button>
    
    <button class="btn btn-secondary" 
            (click)="stopTraining()" 
            [disabled]="!isTraining">
      <span>â¹ï¸</span>
      åœæ­¢è®­ç»ƒ
    </button>

    <button class="btn btn-outline" 
            (click)="resetConfig()" 
            [disabled]="isTraining">
      <span>ğŸ”„</span>
      é‡ç½®å‚æ•°
    </button>
  </div>

  <!-- è®­ç»ƒè¿›åº¦ -->
  <div class="training-progress" *ngIf="isTraining || trainingComplete">
    <h2>è®­ç»ƒè¿›åº¦</h2>
    
    <div class="progress-stats">
      <div class="stat-card">
        <div class="stat-value">{{ progress.currentModel }}</div>
        <div class="stat-label">å½“å‰æ¨¡å‹</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ progress.completed }}/{{ progress.total }}</div>
        <div class="stat-label">å·²å®Œæˆ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ progress.percentage }}%</div>
        <div class="stat-label">è¿›åº¦</div>
      </div>
    </div>

    <div class="progress-bar-container">
      <div class="progress-bar" [style.width.%]="progress.percentage"></div>
    </div>

    <div class="current-status" *ngIf="progress.status">
      <span class="label">çŠ¶æ€:</span>
      <span class="status">{{ progress.status }}</span>
    </div>
  </div>

  <!-- è®­ç»ƒæ—¥å¿— -->
  <div class="training-logs" *ngIf="logs.length > 0">
    <h2>è®­ç»ƒæ—¥å¿—</h2>
    <div class="log-container">
      @for (log of logs; track log.timestamp) {
        <div class="log-entry" [class]="log.type">
          <span class="timestamp">{{ log.timestamp | date:'HH:mm:ss' }}</span>
          <span class="message">{{ log.message }}</span>
        </div>
      }
    </div>
  </div>

  <!-- è®­ç»ƒç»“æœ -->
  <div class="training-results" *ngIf="trainingComplete">
    <h2>è®­ç»ƒç»“æœ</h2>
    
    @for (result of results; track result.modelName) {
      <div class="result-card">
        <h3>{{ result.modelName }}</h3>
        <div class="metrics-grid">
          <div class="metric">
            <span class="label">MAE (å¹³å‡ç»å¯¹è¯¯å·®)</span>
            <span class="value">{{ result.mae | number:'1.0-0' }}</span>
          </div>
          <div class="metric">
            <span class="label">RMSE (å‡æ–¹æ ¹è¯¯å·®)</span>
            <span class="value">{{ result.rmse | number:'1.0-0' }}</span>
          </div>
          <div class="metric">
            <span class="label">RÂ² åˆ†æ•°</span>
            <span class="value" [class.good]="result.r2 > 0.8">{{ result.r2 | number:'1.2-4' }}</span>
          </div>
          <div class="metric">
            <span class="label">è®­ç»ƒæ ·æœ¬æ•°</span>
            <span class="value">{{ result.trainSamples }}</span>
          </div>
        </div>
        
        <div class="feature-importance" *ngIf="result.featureImportance.length > 0">
          <h4>ç‰¹å¾é‡è¦æ€§ Top 5</h4>
          <div class="importance-bars">
            @for (feature of result.featureImportance.slice(0, 5); track feature.name) {
              <div class="importance-item">
                <span class="feature-name">{{ feature.name }}</span>
                <div class="importance-bar-container">
                  <div class="importance-bar" [style.width.%]="feature.importance * 100"></div>
                </div>
                <span class="importance-value">{{ feature.importance | percent:'1.1-1' }}</span>
              </div>
            }
          </div>
        </div>
      </div>
    }

    <div class="result-actions">
      <button class="btn btn-success" (click)="downloadModels()">
        <span>ğŸ“¥</span>
        ä¸‹è½½æ¨¡å‹æ–‡ä»¶
      </button>
      <button class="btn btn-primary" (click)="viewReport()">
        <span>ğŸ“„</span>
        æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š
      </button>
    </div>
  </div>

  <!-- æ¨¡å‹è¯´æ˜ -->
  <div class="model-info">
    <h2>æ¨¡å‹è¯´æ˜</h2>
    <div class="info-grid">
      <div class="info-card">
        <h4>ğŸ¯ é¢„æµ‹ç›®æ ‡</h4>
        <ul>
          <li><strong>å½“å‰åœ¨çº¿äººæ•°</strong>: å®æ—¶åœ¨çº¿ç©å®¶æ•°</li>
          <li><strong>24å°æ—¶å³°å€¼</strong>: è¿‘24å°æ—¶æœ€é«˜åœ¨çº¿</li>
          <li><strong>å†å²æœ€é«˜</strong>: æœ‰å²ä»¥æ¥æœ€é«˜åœ¨çº¿</li>
        </ul>
      </div>
      <div class="info-card">
        <h4>ğŸ“Š ç‰¹å¾åŒ…æ‹¬</h4>
        <ul>
          <li>æ¸¸æˆå¹´é¾„ã€ä»·æ ¼</li>
          <li>å¹³å‡/ä¸­ä½æ•°æ¸¸æˆæ—¶é•¿</li>
          <li>æ¸¸æˆæ—¶é•¿ä»·æ ¼æ¯”</li>
          <li>æ´»è·ƒåº¦æŒ‡æ ‡</li>
        </ul>
      </div>
      <div class="info-card">
        <h4>âš™ï¸ æ¨¡å‹ç®—æ³•</h4>
        <ul>
          <li><strong>RandomForest</strong>: é›†æˆå­¦ä¹ </li>
          <li>é«˜å‡†ç¡®åº¦ã€é˜²è¿‡æ‹Ÿåˆ</li>
          <li>è‡ªåŠ¨ç‰¹å¾é‡è¦æ€§åˆ†æ</li>
        </ul>
      </div>
      <div class="info-card">
        <h4>ğŸ› ï¸ åº”ç”¨åœºæ™¯</h4>
        <ul>
          <li>ç¼ºå¤±æ•°æ®æ™ºèƒ½è¡¥å…¨</li>
          <li>æ¸¸æˆæˆåŠŸé¢„æµ‹</li>
          <li>å¸‚åœºè¶‹åŠ¿åˆ†æ</li>
        </ul>
      </div>
    </div>
  </div>
</div>
